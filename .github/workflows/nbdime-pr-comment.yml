name: Jupyter Notebook Diff on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  notebook_diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for accurate diffs

      - name: Set up Python and install tools
        run: |
          python3 -m pip install --upgrade pip
          pip install nbdime

      - name: Prepare base and head
        run: |
          mkdir -p changelog/notebooks
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git checkout ${{ github.event.pull_request.base.ref }}
          cp -r notebooks base_notebooks

          git checkout ${{ github.event.pull_request.head.ref }}
          cp -r notebooks pr_notebooks

      - name: Generate nbdime diff
        run: |
          python3 -m nbdime diff -OAMID --no-color base_notebooks pr_notebooks > changelog/notebooks/changes.diff || echo "No diff output"

      - name: Post diff as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s changelog/notebooks/changes.diff ]; then
            COMMENT_BODY=$(echo -e "### üìò Jupyter Notebook Diff\n\`\`\`diff\n$(cat changelog/notebooks/changes.diff | head -c 60000)\n\`\`\`")

            # Truncate comment if too large
            if [ $(cat changelog/notebooks/changes.diff | wc -c) -gt 60000 ]; then
              COMMENT_BODY="${COMMENT_BODY}\n\n‚ö†Ô∏è Diff truncated due to size limit."
            fi

            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          else
            echo "No notebook diff to comment."
          fi
