# .github/workflows/nbdime-pr-comment.yml
name: Jupyter Notebook Diff on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate_nb_diff:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Needed to compare with base branch

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install and Verify nbdime
      run: |
        pip install --upgrade nbdime
        nbdime --version
        nbdime diff --help # This will print help specifically for the 'diff' subcommand
      shell: bash

    - name: Get changed notebooks
      id: changed_files
      run: |
        # Compare the head of the PR branch to the base branch it's merging into
        CHANGED_NOTEBOOKS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep ".ipynb$")
        echo "changed_notebooks=$CHANGED_NOTEBOOKS" >> $GITHUB_OUTPUT
      shell: bash

    - name: Generate and Comment nbdime diff
      # Only run if there are actual changed notebooks
      if: steps.changed_files.outputs.changed_notebooks != ''
      run: |
        DIFF_COMMENT=""
        for NOTEBOOK_PATH in ${{ steps.changed_files.outputs.changed_notebooks }}; do
          # Use --strip-outputs and --strip-metadata for better compatibility
          NB_DIFF=$(nbdime diff --strip-outputs --strip-metadata --no-color ${{ github.event.pull_request.base.sha }} $NOTEBOOK_PATH)
          
          if [ -n "$NB_DIFF" ]; then
            DIFF_COMMENT="${DIFF_COMMENT}\n---\n### Code Changes for \`${NOTEBOOK_PATH}\`\n\`\`\`diff\n${NB_DIFF}\n\`\`\`\n"
          fi
        done

        if [ -n "$DIFF_COMMENT" ]; then
          COMMENT_ID=$(gh pr comment list ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json id,body -q '.[] | select(.body | contains("")) | .id' || true)
          CURRENT_TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          FULL_COMMENT_BODY="This comment shows the code-only diff for Jupyter notebooks in this PR.\n*Last updated: ${CURRENT_TIMESTAMP}*\n\n${DIFF_COMMENT}\n"

          if [ -n "$COMMENT_ID" ]; then
            gh pr comment edit $COMMENT_ID --repo ${{ github.repository }} --body "$FULL_COMMENT_BODY"
          else
            gh pr comment create ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "$FULL_COMMENT_BODY"
          fi
        else
          echo "No meaningful notebook diffs to comment on."
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: bash