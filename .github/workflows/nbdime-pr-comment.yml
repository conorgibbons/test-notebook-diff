name: Notebook Diff on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  notebook_diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for diffing

      - name: Set up Python environment and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nbdime nbstripout jq

      - name: Get list of changed notebooks
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '\.ipynb$' || true > changed_notebooks.txt
          echo "Changed notebooks:"
          cat changed_notebooks.txt

      - name: Prepare stripped copies for diffing
        run: |
          mkdir -p tmp_base tmp_head diff_output
          while IFS= read -r nb; do
            if git show origin/${{ github.event.pull_request.base.ref }}:"$nb" &> /dev/null && [ -f "$nb" ]; then
              mkdir -p "tmp_base/$(dirname "$nb")" "tmp_head/$(dirname "$nb")"
              git show origin/${{ github.event.pull_request.base.ref }}:"$nb" > tmp_base/"$nb"
              cp "$nb" tmp_head/"$nb"
              nbstripout tmp_base/"$nb"
              nbstripout tmp_head/"$nb"
            fi
          done < changed_notebooks.txt

      - name: Generate notebook diffs
        run: |
          > diff_output/notebook_diff.txt
          while IFS= read -r nb; do
            base_file="tmp_base/$nb"
            head_file="tmp_head/$nb"
            if [[ -f "$base_file" && -f "$head_file" ]]; then
              echo -e "\n### Diff for \`$nb\`\n\`\`\`diff" >> diff_output/notebook_diff.txt
              python3 -m nbdime diff --no-color "$base_file" "$head_file" >> diff_output/notebook_diff.txt || echo "Error diffing $nb"
              echo -e "\`\`\`\n---" >> diff_output/notebook_diff.txt
            fi
          done < changed_notebooks.txt

      - name: Post notebook diff as PR comment (same repo PRs only)
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -s diff_output/notebook_diff.txt ]; then
            COMMENT_BODY=$(head -c 60000 diff_output/notebook_diff.txt | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr -d '\r\n')
            # Using JSON payload with escaped newlines for safe posting
            PAYLOAD=$(jq -nc --arg body "ðŸ“˜ Jupyter Notebook Changes\n\n$(head -c 60000 diff_output/notebook_diff.txt)" '{body:$body}')

            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
              -d "$PAYLOAD"
          else
            echo "No notebook changes to comment."
          fi
