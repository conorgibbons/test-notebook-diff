name: Notebook Diff in PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  notebook_diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for base comparison

      - name: Set up Python and install nbdime + nbstripout
        run: |
          pip install nbdime nbstripout

      - name: Generate stripped copies of base and head notebooks
        run: |
          mkdir -p diff_output

          # Get list of changed notebooks
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD \
            | grep '\.ipynb$' > changed_files.txt || true

          while IFS= read -r nb; do
            # Make sure the file exists in both branches
            if git show origin/${{ github.event.pull_request.base.ref }}:"$nb" &> /dev/null && [ -f "$nb" ]; then
              mkdir -p "tmp_base/$(dirname "$nb")" "tmp_head/$(dirname "$nb")"

              git show origin/${{ github.event.pull_request.base.ref }}:"$nb" > tmp_base/"$nb"
              cp "$nb" tmp_head/"$nb"

              # Strip outputs and metadata for a cleaner code diff
              nbstripout tmp_base/"$nb"
              nbstripout tmp_head/"$nb"

              echo -e "\n### Diff for \`$nb\`\n\`\`\`diff" >> diff_output/notebook_diff.txt
              python3 -m nbdime diff --no-color tmp_base/"$nb" tmp_head/"$nb" >> diff_output/notebook_diff.txt || echo "Error diffing $nb"
              echo -e "\`\`\`\n---" >> diff_output/notebook_diff.txt
            fi
          done < changed_files.txt

      - name: Comment notebook diff on PR (for same-repo PRs only)
        if: github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -s diff_output/notebook_diff.txt ]; then
            COMMENT_BODY=$(head -c 60000 diff_output/notebook_diff.txt)
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "ðŸ“˜ Jupyter Notebook Changes\n\n${COMMENT_BODY}"
          else
            echo "No notebook changes to comment."
          fi
