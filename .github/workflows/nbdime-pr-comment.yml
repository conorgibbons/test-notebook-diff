name: Notebook Diff as Commit File

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  generate_diff:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and install nbdime
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install nbdime
        run: |
          python -m pip install --upgrade pip
          pip install nbdime

      - name: Generate notebook diff file
        run: |
          DIFF_FILE="nb_diff/changes_for_pr_${{ github.event.pull_request.number }}.diff"
          mkdir -p nb_diff
          # Generate diff between PR base and head for all notebooks
          python3 -m nbdime diff --no-color origin/${{ github.event.pull_request.base.ref }} ${{ github.event.pull_request.head.ref }} . > "$DIFF_FILE" || true

      - name: Commit and push diff file if changed
        if: github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DIFF_FILE="nb_diff/changes_for_pr_${{ github.event.pull_request.number }}.diff"
          git add "$DIFF_FILE"
          if ! git diff --cached --quiet; then
            git commit -m "Add notebook diff for PR #${{ github.event.pull_request.number }}"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No changes in diff file, skipping commit."
          fi

  cleanup_diff:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove notebook diff file on PR close
        if: github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DIFF_FILE="nb_diff/changes_for_pr_${{ github.event.pull_request.number }}.diff"
          if [ -f "$DIFF_FILE" ]; then
            git rm "$DIFF_FILE"
            git commit -m "Remove notebook diff file for closed PR #${{ github.event.pull_request.number }}"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No diff file to remove."
          fi
