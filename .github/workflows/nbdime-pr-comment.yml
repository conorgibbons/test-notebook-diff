# .github/workflows/nbdime-pr-comment.yml
name: Jupyter Notebook Diff on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate_nb_diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed to access both HEAD and base

      - name: Set up Python and Install nbdime
        run: |
          python -m pip install --upgrade pip
          pip install nbdime

      - name: Get changed notebooks
        id: changed
        run: |
          NOTEBOOKS=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep '.ipynb$' || true)
          echo "$NOTEBOOKS"
          echo "notebooks<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTEBOOKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate and comment notebook diffs
        if: steps.changed.outputs.notebooks != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # <-- Use this instead of gh auth login
        run: |
          DIFF_COMMENT=""
          mkdir -p base_notebooks pr_notebooks

          while IFS= read -r nb; do
            mkdir -p "$(dirname base_notebooks/$nb)"
            mkdir -p "$(dirname pr_notebooks/$nb)"

            git show ${{ github.event.pull_request.base.sha }}:"$nb" > base_notebooks/"$nb" || continue
            cp "$nb" pr_notebooks/"$nb"

            NB_DIFF=$(nbdime diff --strip-outputs --strip-metadata --no-color base_notebooks/"$nb" pr_notebooks/"$nb")
            if [ -n "$NB_DIFF" ]; then
              DIFF_COMMENT="${DIFF_COMMENT}\n---\n### \`${nb}\`\n\`\`\`diff\n${NB_DIFF}\n\`\`\`\n"
            fi
          done <<< "${{ steps.changed.outputs.notebooks }}"

          if [ -n "$DIFF_COMMENT" ]; then
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            BODY="This comment shows code-only diffs for Jupyter notebooks.\n_Last updated: $TIMESTAMP_\n\n${DIFF_COMMENT}"

            gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
          else
            echo "No notebook diffs to show."
          fi
